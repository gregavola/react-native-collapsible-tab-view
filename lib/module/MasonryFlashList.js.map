{"version":3,"names":["React","useCallback","Animated","useAnimatedReaction","useSharedValue","useChainCallback","useCollapsibleStyle","useScrollHandlerY","useSharedAnimatedRef","useTabNameContext","useTabsContext","useUpdateScrollViewContentSize","AnimatedMasonry","ensureMasonry","flashListModule","require","createAnimatedComponent","MasonryFlashList","console","error","MasonryFlashListMemo","memo","forwardRef","props","passRef","MasonryFlashListImpl","style","onContentSizeChange","contentContainerStyle","_contentContainerStyle","refreshControl","rest","name","setRef","contentInset","recyclerRef","ref","scrollHandler","enable","hadLoad","onLoad","value","ready","progressViewOffset","useEffect","scrollContentSizeChange","scrollContentSizeChangeHandlers","useMemo","memoRefreshControl","cloneElement","memoContentInset","top","memoContentOffset","x","y","memoContentContainerStyle","paddingTop","refWorkaround","recyclerlistview_unsafe"],"sources":["MasonryFlashList.tsx"],"sourcesContent":["import { MasonryFlashListProps, MasonryFlashListRef } from '@shopify/flash-list'\nimport React, { useCallback } from 'react'\nimport Animated, {\n  useAnimatedReaction,\n  useSharedValue,\n} from 'react-native-reanimated'\n\nimport {\n  useChainCallback,\n  useCollapsibleStyle,\n  useScrollHandlerY,\n  useSharedAnimatedRef,\n  useTabNameContext,\n  useTabsContext,\n  useUpdateScrollViewContentSize,\n} from './hooks'\n\n/**\n * Used as a memo to prevent rerendering too often when the context changes.\n * See: https://github.com/facebook/react/issues/15156#issuecomment-474590693\n */\n\ntype MasonryFlashListMemoProps = React.PropsWithChildren<\n  MasonryFlashListProps<unknown>\n>\ntype MasonryFlashListMemoRef = MasonryFlashListRef<any>\n\nlet AnimatedMasonry: React.ComponentClass<MasonryFlashListProps<any>> | null =\n  null\n\nconst ensureMasonry = () => {\n  if (AnimatedMasonry) {\n    return\n  }\n\n  try {\n    const flashListModule = require('@shopify/flash-list')\n    AnimatedMasonry = Animated.createAnimatedComponent(\n      flashListModule.MasonryFlashList\n    ) as unknown as React.ComponentClass<MasonryFlashListProps<any>>\n  } catch {\n    console.error(\n      'The optional dependency @shopify/flash-list is not installed. Please install it to use the FlashList component.'\n    )\n  }\n}\n\nconst MasonryFlashListMemo = React.memo(\n  React.forwardRef<MasonryFlashListMemoRef, MasonryFlashListMemoProps>(\n    (props, passRef) => {\n      ensureMasonry()\n      return AnimatedMasonry ? (\n        // @ts-expect-error\n        <AnimatedMasonry ref={passRef} {...props} />\n      ) : (\n        <></>\n      )\n    }\n  )\n)\n\nfunction MasonryFlashListImpl<R>(\n  {\n    style,\n    onContentSizeChange,\n    contentContainerStyle: _contentContainerStyle,\n    refreshControl,\n    ...rest\n  }: Omit<MasonryFlashListProps<R>, 'onScroll'>,\n  passRef: React.Ref<MasonryFlashListMemoRef>\n) {\n  const name = useTabNameContext()\n  const { setRef, contentInset } = useTabsContext()\n  const recyclerRef = useSharedAnimatedRef<any>(null)\n  const ref = useSharedAnimatedRef<any>(passRef)\n\n  const { scrollHandler, enable } = useScrollHandlerY(name)\n\n  const hadLoad = useSharedValue(false)\n\n  const onLoad = useCallback(() => {\n    hadLoad.value = true\n  }, [hadLoad])\n\n  useAnimatedReaction(\n    () => {\n      return hadLoad.value\n    },\n    (ready) => {\n      if (ready) {\n        enable(true)\n      }\n    }\n  )\n\n  const { progressViewOffset, contentContainerStyle } = useCollapsibleStyle()\n\n  React.useEffect(() => {\n    setRef(name, recyclerRef)\n  }, [name, recyclerRef, setRef])\n\n  const scrollContentSizeChange = useUpdateScrollViewContentSize({\n    name,\n  })\n\n  const scrollContentSizeChangeHandlers = useChainCallback(\n    React.useMemo(\n      () => [scrollContentSizeChange, onContentSizeChange],\n      [onContentSizeChange, scrollContentSizeChange]\n    )\n  )\n\n  const memoRefreshControl = React.useMemo(\n    () =>\n      refreshControl &&\n      React.cloneElement(refreshControl, {\n        progressViewOffset,\n        ...refreshControl.props,\n      }),\n    [progressViewOffset, refreshControl]\n  )\n\n  const memoContentInset = React.useMemo(\n    () => ({ top: contentInset }),\n    [contentInset]\n  )\n\n  const memoContentOffset = React.useMemo(\n    () => ({ x: 0, y: -contentInset }),\n    [contentInset]\n  )\n\n  const memoContentContainerStyle = React.useMemo(\n    () => ({\n      paddingTop: contentContainerStyle.paddingTop,\n      ..._contentContainerStyle,\n    }),\n    [_contentContainerStyle, contentContainerStyle.paddingTop]\n  )\n\n  const refWorkaround = useCallback(\n    (value: MasonryFlashListMemoRef | null): void => {\n      // https://github.com/Shopify/flash-list/blob/2d31530ed447a314ec5429754c7ce88dad8fd087/src/FlashList.tsx#L829\n      // We are not accessing the right element or view of the Flashlist (recyclerlistview). So we need to give\n      // this ref the access to it\n      // @ts-expect-error\n      ;(recyclerRef as any)(value?.recyclerlistview_unsafe)\n      ;(ref as any)(value)\n    },\n    [recyclerRef, ref]\n  )\n\n  return (\n    // @ts-expect-error typescript complains about `unknown` in the memo, it should be T\n    <MasonryFlashListMemo\n      {...rest}\n      onLoad={onLoad}\n      contentContainerStyle={memoContentContainerStyle}\n      ref={refWorkaround}\n      bouncesZoom={false}\n      onScroll={scrollHandler}\n      scrollEventThrottle={16}\n      contentInset={memoContentInset}\n      contentOffset={memoContentOffset}\n      refreshControl={memoRefreshControl}\n      progressViewOffset={progressViewOffset}\n      automaticallyAdjustContentInsets={false}\n      onContentSizeChange={scrollContentSizeChangeHandlers}\n    />\n  )\n}\n\n/**\n * Use like a regular MasonryFlashList.\n */\nexport const MasonryFlashList = React.forwardRef(MasonryFlashListImpl) as <T>(\n  p: MasonryFlashListProps<T> & { ref?: React.Ref<MasonryFlashListMemoRef> }\n) => React.ReactElement\n"],"mappings":"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"}